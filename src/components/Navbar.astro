---
// Navbar.astro
const { pathname } = Astro.url;
---

<nav h-16 px-4 pt-6 bg-white border-b border-neutral-100 flex="~ items-center justify-between">
  <!-- Search Area -->
  <div flex-1 mr-4 flex items-center>
    <div relative w-full max-w-md id="search-container"> <!-- Tambah ID container -->
      <input 
        id="global-search" type="text" 
        placeholder="Cari layanan..." 
        class="peer"
        bg-neutral-100 border="~ transparent" focus:border-yellow-400 focus:bg-white
        w-full p-2.5 pl-10 rounded-xl outline-none transition-all text-sm
        autocomplete="off"
      >
      <div 
        i-ph-magnifying-glass 
        absolute left-3 top="1/2" 
        class="-translate-y-1/2 text-gray-400 transition-colors peer-focus:text-yellow-500"
      ></div>

      <!-- Search Results Dropdown -->
      <div id="search-results" 
        class="hidden absolute top-full left-0 right-0 mt-2 bg-white rounded-2xl shadow-2xl border border-neutral-100 overflow-hidden z-60 max-h-96 overflow-y-auto"
      >
        <div id="search-list" class="divide-y divide-neutral-50"></div>
      </div>
    </div>
  </div>

  <!-- Cart Badge -->
  <a href="/cart" relative p-2 block hover:text-gray-800 text-gray-600 transition-colors>
    <div i-ph-shopping-cart text-2xl class={pathname === '/cart' ? 'text-yellow-500' : ''}></div>
    <span id="cart-badge" class="hidden absolute top-1 right-1 flex items-center justify-center min-w-5 min-h-5 text-[10px] text-white font-bold bg-red-600 rounded-full border-2 border-white translate-x-1/2 -translate-y-1/2">
      0
    </span>
  </a>
</nav>

<script>
  import { cartManager } from '../services/cartService';
  import { serviceApi } from '../services/serviceApi';

  function initNavbar() {
    const searchContainer = document.getElementById('search-container');
    const searchInput = document.getElementById('global-search') as HTMLInputElement;
    const searchResults = document.getElementById('search-results');
    const searchList = document.getElementById('search-list');
    const badge = document.getElementById('cart-badge');
    let searchTimeout: ReturnType<typeof setTimeout>;

    const updateBadge = () => {
      const total = cartManager.getTotalItems();
      if (badge) {
        badge.textContent = total.toString();
        total > 0 ? badge.classList.remove('hidden') : badge.classList.add('hidden');
      }
    };

    const showResults = (htmlContent: string) => {
      if (!searchResults || !searchList) return;
      
      searchList.innerHTML = htmlContent;
      searchResults.classList.remove('hidden');
      searchResults.classList.add('animate-search-show');

      // Berikan delay stagger pada setiap item hasil
      const items = searchList.querySelectorAll('.search-item-anim');
      items.forEach((item, index) => {
        (item as HTMLElement).style.animationDelay = `${index * 40}ms`;
      });
    };

    const hideResults = () => {
      searchResults?.classList.add('hidden');
      searchResults?.classList.remove('animate-search-show');
    };

    // SEARCH LOGIC
    searchInput?.addEventListener('input', async (e) => {
      const query = (e.target as HTMLInputElement).value.toLowerCase().trim();
      
      clearTimeout(searchTimeout);

      if (query.length < 2) {
        hideResults();
        return;
      }

      searchTimeout = setTimeout(async () => {
        const services = await serviceApi.getAllServices();
        const filtered = services.filter(s => 
          s.name.toLowerCase().includes(query) || 
          s.category.toLowerCase().includes(query)
        );
  
        if (filtered.length > 0) {
          const html = filtered.map(s => `
            <a href="/layanan?id=${s.id}" class="search-item-anim flex items-center gap-3 p-3 hover:bg-yellow-50 transition-all border-l-4 border-transparent hover:border-yellow-400">
              <img src="${s.img}" class="w-10 h-10 rounded-lg object-cover bg-neutral-100" />
              <div class="flex-1">
                <p class="text-sm font-bold text-neutral-800">${s.name}</p>
                <p class="text-[10px] text-neutral-400 uppercase font-semibold">${s.category}</p>
              </div>
              <p class="text-xs font-black text-yellow-600">Rp ${(s.price/1000).toFixed(0)}k</p>
            </a>
          `).join('');
          showResults(html);
        } else {
          showResults(`
            <div class="p-8 text-center animate-search-show">
              <div class="i-ph-magnifying-glass-light text-4xl mx-auto text-neutral-200 mb-3"></div>
              <p class="text-sm text-neutral-500 font-medium">Layanan tidak ditemukan</p>
              <p class="text-[10px] text-neutral-400">Coba kata kunci lain</p>
            </div>
          `);
        }
      }, 300)

    });

    // CLOSE ON CLICK OUTSIDE
    document.addEventListener('click', (e) => {
      if (!searchContainer?.contains(e.target as Node)) {
        hideResults();
      }
    });

    // CLOSE ON ESCAPE KEY
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') hideResults();
    });

    // INITIAL LOAD
    updateBadge();
    window.addEventListener('cart-updated', updateBadge);
  }

  // Support Astro Transitions
  initNavbar();
  document.addEventListener('astro:page-load', initNavbar);
</script>

<style is:global>
  @keyframes searchSlideIn {
    from {
      opacity: 0;
      transform: translateY(10px) scale(0.98);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  @keyframes itemReveal {
    from {
      opacity: 0;
      transform: translateX(-10px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  /* Class untuk container dropdown */
  .animate-search-show {
    display: block !important;
    animation: searchSlideIn 0.25s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  /* Class untuk item hasil pencarian */
  .search-item-anim {
    opacity: 0;
    animation: itemReveal 0.3s ease-out forwards;
  }
</style>