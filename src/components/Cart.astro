---
// src/components/Cart.astro
import { formatCurrency } from '../utils/format';

interface Props {
  isOpen?: boolean;
}

const { isOpen = false } = Astro.props;
---

<div
  id="cart-modal"
  fixed inset-0 z-50 transition="all duration-300"
  class={isOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}
>
  {/* Backdrop */}
  <div
    id="cart-backdrop"
    absolute inset-0 bg="black/40" backdrop="blur-sm"
    onclick="document.getElementById('cart-modal').classList.add('hidden')"
  />

  {/* Cart Sidebar */}
  <div
    id="cart-sidebar"
    absolute right-0 top-0 bottom-0 w-full max-w-sm 
    bg-white shadow-2xl transition-transform duration-300 overflow-y-auto
    class={isOpen ? 'translate-x-0' : 'translate-x-full'}
  >
    <div sticky top-0 bg-white border="b neutral-200" p-6 flex="~ items-center justify-between">
      <h2 text-xl font-bold text-neutral-900>Keranjang</h2>
      <button
        id="close-cart"
        p-2 rounded-lg transition-colors
        hover="bg-neutral-100"
        aria-label="Close cart"
      >
        <i-lucide-x text="2xl neutral-600" />
      </button>
    </div>

    {/* Cart Items */}
    <div id="cart-items" p-6 space-y-4>
      {/* Items di-inject oleh JS */}
    </div>

    {/* Cart Summary */}
    <div sticky bottom-0 bg-white border="t neutral-200" p-6 space-y-4>
      <div flex="~ justify-between items-center">
        <span text-neutral-600>Subtotal:</span>
        <span id="subtotal" font-semibold text-neutral-900>Rp 0</span>
      </div>
      <div flex="~ justify-between items-center">
        <span text-neutral-600>Tax (10%):</span>
        <span id="tax" font-semibold text-neutral-900>Rp 0</span>
      </div>
      <div border="t neutral-200" pt-4 flex="~ justify-between items-center">
        <span text-lg font-bold text-neutral-900>Total:</span>
        <span id="total" text="lg yellow-600" font-bold>Rp 0</span>
      </div>
      
      <button
        id="checkout-btn"
        w-full py-3 rounded-xl font-bold transition="all duration-300" active="scale-95" shadow-lg
        bg="gradient-to-r from-yellow-400 to-yellow-600 hover:from-yellow-500 hover:to-yellow-700"
        text="neutral-900"
      >
        Checkout
      </button>
      
      <button
        id="continue-shopping"
        w-full py-3 rounded-xl font-semibold transition-colors
        bg="neutral-100 hover:neutral-200"
        text="neutral-900"
      >
        Lanjut Belanja
      </button>
    </div>
  </div>
</div>

<script>
  import { cartManager } from '../services/cartService';

  /**
   * UNO_SAFELIST: 
   * i-lucide-shopping-cart i-lucide-trash-2 i-lucide-plus i-lucide-minus
   * flex gap-4 p-4 bg-neutral-50 rounded-xl border border-neutral-200 
   * hover:border-yellow-300 w-20 h-20 object-cover rounded-lg flex-1 
   * font-semibold text-neutral-900 text-sm text-xs text-neutral-500 mt-1 
   * mt-2 flex items-center gap-2 px-2 py-1 bg-neutral-200 
   * hover:bg-neutral-300 rounded text-xs font-semibold text-sm 
   * font-bold text-yellow-600 mt-2 text-neutral-400 hover:text-red-500 
   * text-xl text-5xl text-neutral-300 mb-4 text-center
   */

  declare global {
    interface Window {
      cartManager: typeof cartManager;
    }
  }

  const cartModal = document.getElementById('cart-modal');
  const closeCartBtn = document.getElementById('close-cart');
  const continueShoppingBtn = document.getElementById('continue-shopping');
  const cartItemsContainer = document.getElementById('cart-items');

  // Close cart
  closeCartBtn?.addEventListener('click', () => {
    cartModal?.classList.add('hidden');
  });

  continueShoppingBtn?.addEventListener('click', () => {
    cartModal?.classList.add('hidden');
  });

  // Render cart items
  function renderCart() {
    const cart = cartManager.getCart();

    if (cart.items.length === 0) {
      cartItemsContainer!.innerHTML = `
        <div class="flex flex-col items-center justify-center py-12">
          <div class="i-lucide-shopping-cart text-5xl text-neutral-300 mb-4"></div>
          <p class="text-neutral-500 text-center">Keranjang Anda kosong</p>
        </div>
      `;
      return;
    }

    cartItemsContainer!.innerHTML = cart.items
      .map(
        (item) => `
          <div class="flex gap-4 p-4 bg-neutral-50 rounded-xl border border-neutral-200 hover:border-yellow-300 transition-colors">
            <img
              src="${item.img}"
              alt="${item.name}"
              class="w-20 h-20 object-cover rounded-lg"
            />
            <div class="flex-1">
              <h3 class="font-semibold text-neutral-900 text-sm">${item.name}</h3>
              <p class="text-xs text-neutral-500 mt-1">${item.description}</p>
              <div class="mt-2 flex items-center gap-2">
                <button
                  class="px-2 py-1 bg-neutral-200 hover:bg-neutral-300 rounded text-xs font-semibold"
                  onclick="window.cartManager.updateSize(${item.id}, ${item.size - 1}); location.reload()"
                >
                  -
                </button>
                <span class="text-sm font-semibold">${item.size}</span>
                <button
                  class="px-2 py-1 bg-neutral-200 hover:bg-neutral-300 rounded text-xs font-semibold"
                  onclick="window.cartManager.updateSize(${item.id}, ${item.size + 1}); location.reload()"
                >
                  +
                </button>
              </div>
              <p class="text-sm font-bold text-yellow-600 mt-2">
                ${new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(item.price * item.size)}
              </p>
            </div>
            <button
              class="text-neutral-400 hover:text-red-500 transition-colors"
              onclick="window.cartManager.removeFromCart(${item.id}); location.reload()"
              aria-label="Remove item"
            >
              <div class="i-lucide-trash-2 text-xl"></div>
            </button>
          </div>
        `
      )
      .join('');

    // Update totals
    const taxRate = 0.1;
    const tax = Math.round(cart.totalPrice * taxRate);
    const total = cart.totalPrice + tax;

    document.getElementById('subtotal')!.textContent = new Intl.NumberFormat('id-ID', {
      style: 'currency',
      currency: 'IDR',
      minimumFractionDigits: 0,
    }).format(cart.totalPrice);

    document.getElementById('tax')!.textContent = new Intl.NumberFormat('id-ID', {
      style: 'currency',
      currency: 'IDR',
      minimumFractionDigits: 0,
    }).format(tax);

    document.getElementById('total')!.textContent = new Intl.NumberFormat('id-ID', {
      style: 'currency',
      currency: 'IDR',
      minimumFractionDigits: 0,
    }).format(total);
  }

  // Initial render
  renderCart();

  // Make cartManager global untuk onclick handlers
  (window as any).cartManager = (window as any).cartManager || { ...cartManager };
</script>