---
// src/pages/cart/index.astro
import Layout from '../../layouts/Layout.astro';
import { formatCurrency } from '../../utils/format';
---

<Layout title="Shopping Cart">
  <div m="5 t-8" pb-32 max-w-5xl mx-auto> <!-- Ditambahkan max-w agar tidak terlalu lebar di desktop -->
    <!-- Header -->
    <div mb-8 class="animate-fade-in">
      <div flex="~ items-center gap-3" mb-4>
        <a href="/layanan" p-2 rounded-lg transition-colors hover="bg-neutral-100" aria-label="Kembali ke layanan">
          <div i-ph-arrow-left-bold text="2xl neutral-600" />
        </a>
        <h1 text="3xl neutral-900" font-black tracking-tight>Keranjang Belanja</h1>
      </div>
      <p text-neutral-500 font-medium pl-6>
        Kamu memiliki <span id="item-count" font-bold text-neutral-900>0</span> layanan dalam keranjang
      </p>
    </div>

    <div grid="~ cols-1 lg:cols-3" gap-8>
      <!-- Cart Items Section -->
      <div lg="col-span-2">
        <div id="cart-items-container" space-y-4>
          <!-- Loader saat inisialisasi -->
          <div flex="~ col items-center justify-center" py-20 bg-neutral-50 rounded-3xl border="2 dashed neutral-200">
             <div w-12 h-12 border="4 neutral-100 t-yellow-500" rounded-full class="animate-spin"></div>
          </div>
        </div>
      </div>

      <!-- Summary Section -->
      <div lg="col-span-1">
        <div sticky top-24 space-y-6>
          <div bg-white rounded-3xl border="~ neutral-100" p-6 shadow-xl shadow-neutral-200/50>
            <h2 text="lg neutral-900" font-black mb-6 italic>Order Summary</h2>

            <div space-y-4 mb-6 pb-6 border="b neutral-100">
              <div flex="~ justify-between items-center">
                <span text="sm neutral-500" font-bold uppercase tracking-tighter>Subtotal</span>
                <span id="summary-subtotal" font-bold text-neutral-900>Rp 0</span>
              </div>
              <div flex="~ justify-between items-center">
                <span text="sm neutral-500" font-bold uppercase tracking-tighter>Tax (10%)</span>
                <span id="summary-tax" font-bold text-neutral-900>Rp 0</span>
              </div>
            </div>

            <div flex="~ justify-between items-center" mb-8>
              <span text="lg neutral-900" font-black uppercase tracking-tighter>Total</span>
              <span id="summary-total" text="2xl yellow-600" font-black>Rp 0</span>
            </div>

            <div space-y-3>
                <button
                  id="checkout-btn"
                  w-full py-4 rounded-2xl font-black transition-all active:scale-95 shadow-lg
                  bg="gradient-to-r from-yellow-400 to-yellow-500 disabled:neutral-200"
                  text="neutral-900 disabled:neutral-400"
                  disabled
                >
                  <div flex="~ items-center justify-center gap-2">
                    <span>Checkout Now</span>
                    <div i-ph-caret-double-right-bold text-lg />
                  </div>
                </button>

                <button
                  id="continue-shopping-btn"
                  w-full py-3 rounded-xl font-bold transition-colors
                  bg="neutral-100 hover:neutral-200" text-neutral-600 text-sm
                >
                  Lanjut Belanja
                </button>
            </div>
          </div>

          <!-- Info Card (Phosphor Icons Consistent) -->
          <div bg-neutral-50 rounded-2xl p-6 border="~ neutral-100" space-y-4 shadow-sm>
            <div flex="~ gap-4">
              <div i-ph-clock-bold text="green-500 xl" flex-shrink-0 />
              <div>
                <p font-black text="neutral-900 sm" leading-tight>Fast Response</p>
                <p text="neutral-500 [11px]" mt-0.5>Tiba dalam 2-4 jam</p>
              </div>
            </div>
            <div flex="~ gap-4">
              <div i-ph-shield-check-bold text="blue-500 xl" flex-shrink-0 />
              <div>
                <p font-black text="neutral-900 sm" leading-tight>Safe Payment</p>
                <p text="neutral-500 [11px]" mt-0.5>SSL 256-bit Encrypted</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>


<style>
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .cart-item {
    animation: slideIn 0.3s ease-out forwards;
  }
</style>

<script>
  import { cartManager } from '../../services/cartService';

  function initCart() {
    const cartItemsContainer = document.getElementById('cart-items-container');
    const itemCountEl = document.getElementById('item-count');
    const checkoutBtn = document.getElementById('checkout-btn') as HTMLButtonElement;
    const continueShoppingBtn = document.getElementById('continue-shopping-btn');

    const formatter = new Intl.NumberFormat('id-ID', { 
      style: 'currency', 
      currency: 'IDR', 
      minimumFractionDigits: 0 
    });

    function renderCart() {
      const cart = cartManager.getCart();
      if (!cartItemsContainer || !itemCountEl) return;

      itemCountEl.textContent = String(cart.totalItems);

      if (cart.items.length === 0) {
        cartItemsContainer.innerHTML = `
          <div class="flex flex-col items-center justify-center py-20 bg-neutral-50 rounded-3xl border-2 border-dashed border-neutral-200 animate-fade-in">
            <div class="i-ph-shopping-bag-light text-6xl text-neutral-300 mb-4"></div>
            <p class="text-neutral-500 text-lg font-bold">Keranjang kosong</p>
            <p class="text-neutral-400 text-sm mb-6">Kamu belum menambahkan layanan apa pun</p>
            <a href="/layanan" class="px-8 py-3 bg-neutral-900 text-white font-bold rounded-xl hover:bg-neutral-800 transition-all">
              Mulai Belanja
            </a>
          </div>
        `;
        if (checkoutBtn) checkoutBtn.disabled = true;
        return;
      }

      cartItemsContainer.innerHTML = cart.items.map((item, index) => `
        <div class="cart-item bg-white rounded-3xl border border-neutral-100 p-5 hover:shadow-xl hover:border-yellow-200 transition-all" style="animation-delay: ${index * 50}ms">
          <div class="flex flex-col md:flex-row gap-5">
            <img src="${item.img}" class="w-full md:w-24 h-24 object-cover rounded-2xl bg-neutral-100" />
            <div class="flex-1 flex flex-col justify-between">
              <div class="flex justify-between items-start">
                <div>
                  <h3 class="font-black text-neutral-900 text-lg leading-tight">${item.name}</h3>
                  <p class="text-neutral-400 text-xs mt-1 line-clamp-1">${item.description}</p>
                </div>
                <button onclick="window.removeFromCart(${item.id})" class="p-2 text-neutral-300 hover:text-red-500 hover:bg-red-50 rounded-xl transition-all">
                  <div class="i-ph-trash-bold text-xl"></div>
                </button>
              </div>

              <div class="flex flex-wrap items-center justify-between gap-4 mt-4">
                <div class="flex items-center gap-3 bg-neutral-50 p-1.5 rounded-2xl border border-neutral-100">
                  <button onclick="window.updateSize(${item.id}, ${item.size - 1})" class="w-8 h-8 flex items-center justify-center bg-white border border-neutral-200 rounded-xl hover:bg-neutral-900 hover:text-white transition-all">
                    <div class="i-ph-minus-bold text-sm"></div>
                  </button>
                  <span class="min-w-10 text-center font-black text-neutral-900 text-sm">${item.size}mÂ²</span>
                  <button onclick="window.updateSize(${item.id}, ${item.size + 1})" class="w-8 h-8 flex items-center justify-center bg-white border border-neutral-200 rounded-xl hover:bg-neutral-900 hover:text-white transition-all">
                    <div class="i-ph-plus-bold text-sm"></div>
                  </button>
                </div>
                <div class="text-right">
                  <p class="text-[9px] text-neutral-400 font-bold uppercase tracking-widest leading-none mb-1">Total Item</p>
                  <p class="text-xl font-black text-yellow-600 leading-none">${formatter.format(item.price * item.size)}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      `).join('');

      const tax = Math.round(cart.totalPrice * 0.1);
      document.getElementById('summary-subtotal')!.textContent = formatter.format(cart.totalPrice);
      document.getElementById('summary-tax')!.textContent = formatter.format(tax);
      document.getElementById('summary-total')!.textContent = formatter.format(cart.totalPrice + tax);
      if (checkoutBtn) checkoutBtn.disabled = false;
    }

    // Global Handlers
    window.removeFromCart = (id) => { cartManager.removeFromCart(id); renderCart(); };
    window.updateSize = (id, size) => { if (size > 0) { cartManager.updateSize(id, size); renderCart(); } };

    continueShoppingBtn?.addEventListener('click', () => window.location.href = '/layanan');
    checkoutBtn?.addEventListener('click', () => {
      const order = cartManager.checkout();
      if (order) {
        window.location.href = '/orders/history'; 
      }
    });

    renderCart();
  }

  // Penting: Agar script jalan saat navigasi seamless
  document.addEventListener('astro:page-load', initCart);
</script>