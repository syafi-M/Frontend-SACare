---
// src/pages/profile/index.astro
import UserProfile from '../../components/UserProfile.astro';
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Profil Saya | SACare">
  <div px-4 max-w-2xl mx-auto pb-32 m="md:5 t-8">
    <!-- User Profile Header with Server Island -->
    <UserProfile server:defer>
      <div slot="fallback" flex="~ col items-center" mb-10 class="animate-pulse">
        <div w-24 h-24 md="w-32 h-32" rounded-3xl bg-neutral-200 shadow-sm></div>
        <div h-6 bg-neutral-200 rounded-full w-32 mt-4></div>
        <div h-4 bg-neutral-200 rounded-full w-48 mt-2></div>
      </div>
    </UserProfile>

    <!-- Stats Grid -->
    <div grid="~ cols-2" gap-4 mb-8 class="animate-fade-in">
      <div bg-white p-5 rounded-3xl border="~ neutral-100" text-center shadow-sm>
        <p id="order-count" text="2xl neutral-900" font-black leading-none mb-2>0</p>
        <p text="[10px] neutral-400" font-bold uppercase tracking-widest>Total Pesanan</p>
      </div>
      <div bg-white p-5 rounded-3xl border="~ neutral-100" text-center shadow-sm>
        <p text="2xl neutral-900" font-black leading-none mb-2>0</p>
        <p text="[10px] neutral-400" font-bold uppercase tracking-widest>Poin Reward</p>
      </div>
    </div>

    <!-- Menu List -->
    <div bg-white border="~ neutral-100" rounded-3xl overflow-hidden shadow-xl shadow-neutral-200/40 class="animate-fade-in animate-delay-100">
      <div class="divide-y divide-neutral-50">
        
        <!-- Riwayat Pesanan -->
        <a href="/orders/history" flex="~ items-center justify-between" p-5 hover="bg-neutral-50" transition-colors class="group">
          <div flex="~ items-center gap-4">
            <div p-2.5 bg-blue-50 text-blue-600 rounded-2xl group-hover="bg-blue-600 text-white" transition-all duration-300 shadow-sm>
              <div class="i-ph-receipt-bold text-xl"></div>
            </div>
            <span font-bold text-neutral-800>Riwayat Pesanan</span>
          </div>
          <div class="i-ph-caret-right-bold text-neutral-300 group-hover:text-neutral-900 group-hover:translate-x-1 transition-all"></div>
        </a>

        <!-- Alamat -->
        <a href="#" flex="~ items-center justify-between" p-5 hover="bg-neutral-50" transition-colors class="group">
          <div flex="~ items-center gap-4">
            <div p-2.5 bg-yellow-50 text-yellow-600 rounded-2xl group-hover="bg-yellow-500 text-white" transition-all duration-300 shadow-sm>
              <div class="i-ph-map-pin-bold text-xl"></div>
            </div>
            <span font-bold text-neutral-800>Alamat Tersimpan</span>
          </div>
          <div class="i-ph-caret-right-bold text-neutral-300 group-hover:text-neutral-900 group-hover:translate-x-1 transition-all"></div>
        </a>

        <!-- Pembayaran -->
        <a href="#" flex="~ items-center justify-between" p-5 hover="bg-neutral-50" transition-colors class="group">
          <div flex="~ items-center gap-4">
            <div p-2.5 bg-purple-50 text-purple-600 rounded-2xl group-hover="bg-purple-600 text-white" transition-all duration-300 shadow-sm>
              <div class="i-ph-credit-card-bold text-xl"></div>
            </div>
            <span font-bold text-neutral-800>Metode Pembayaran</span>
          </div>
          <div class="i-ph-caret-right-bold text-neutral-300 group-hover:text-neutral-900 group-hover:translate-x-1 transition-all"></div>
        </a>

        <!-- Logout -->
        <button id="logout-trigger" w-full flex="~ items-center justify-between" p-5 hover="bg-red-50" transition-colors class="group text-red-600">
          <div flex="~ items-center gap-4">
            <div p-2.5 bg-red-50 text-red-600 rounded-2xl group-hover="bg-red-600 text-white" transition-all duration-300 shadow-sm>
              <div class="i-ph-sign-out-bold text-xl"></div>
            </div>
            <span font-bold>Keluar Akun</span>
          </div>
          <div class="i-ph-caret-right-bold text-red-200 group-hover:text-red-600 transition-all"></div>
        </button>

      </div>
    </div>
  </div>
</Layout>

<script>
  import { cartManager } from '../../services/cartService';
  import { actions } from 'astro:actions';
  
  function initProfile() {
    // 1. Update Statistik Secara Real-time
    const orderCountEl = document.getElementById('order-count');
    if (orderCountEl) {
      const history = cartManager.getOrderHistory();
      orderCountEl.textContent = history.length.toString();
    }

    // 2. Logout Logic
    const logoutBtn = document.getElementById('logout-trigger');
    logoutBtn?.addEventListener('click', async (e) => {
      e.preventDefault();
      if(confirm('Apakah Anda yakin ingin keluar?')) {
        await actions.logout();
        window.location.href = '/';
      }
    });
  }

  // View Transitions Support
  document.addEventListener('astro:page-load', initProfile);
</script>