---
// /src/pages/orders/history.astro
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Riwayat Pesanan | SACare">
  <div px-4 max-w-4xl mx-auto pb-24 m="md:5 t-8">
    <!-- Header -->
    <div flex="~ items-center gap-3" mb="6 md:8" class="animate-fade-in">
      <a href="/profile" p-2 rounded-lg transition-colors hover="bg-neutral-100" aria-label="Kembali ke profil">
        <div i-ph-arrow-left-bold text="xl md:2xl neutral-600" />
      </a>
      <h1 text="2xl md:3xl neutral-900" font-black tracking-tight>Riwayat Pesanan</h1>
    </div>

    <!-- Container Utama -->
    <div id="history-container" space-y="4 md:6">
      <!-- Skeleton Loading (Match dengan Card Original) -->
      <div flex="~ col gap-4" class="animate-pulse">
        <div h-40 bg-neutral-100 rounded-3xl w-full border="~ neutral-50"></div>
        <div h-40 bg-neutral-100 rounded-3xl w-full border="~ neutral-50"></div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { cartManager } from '../../services/cartService';

  function initHistory() {
    const container = document.getElementById('history-container');
    if (!container) return;

    // Helper untuk Warna Status
    function getStatusStyle(status: string) {
      const styles = {
        'Completed': 'bg-green-50 text-green-700 border-green-200',
        'On Progress': 'bg-blue-50 text-blue-700 border-blue-200',
        'Cancelled': 'bg-red-50 text-red-700 border-red-200'
      };
      return styles[status] || 'bg-yellow-50 text-yellow-700 border-yellow-200';
    }

    function renderHistory() {
      const orders = cartManager.getOrderHistory();
      const priceFormatter = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 });
      const dateFormatter = new Intl.DateTimeFormat('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });

      if (orders.length === 0) {
        container.innerHTML = `
          <div class="text-center py-20 bg-neutral-50 rounded-3xl border-2 border-dashed border-neutral-200 px-6 animate-fade-in">
            <div class="i-ph-file-text-light text-6xl text-neutral-300 mx-auto mb-4"></div>
            <p class="text-neutral-900 font-bold text-lg">Belum Ada Pesanan</p>
            <p class="text-neutral-400 text-sm mb-6">Riwayat pesanan kamu akan muncul di sini.</p>
            <a href="/layanan" class="px-6 py-3 bg-neutral-900 text-white font-bold rounded-xl hover:bg-neutral-800 transition-all">Cari Layanan</a>
          </div>
        `;
        return;
      }

      container.innerHTML = orders.map((order, idx) => `
        <div class="bg-white border border-neutral-100 rounded-3xl overflow-hidden shadow-sm hover:shadow-xl hover:border-yellow-200 transition-all animate-fade-in" style="animation-delay: ${idx * 100}ms">
          <!-- Header Pesanan -->
          <div class="bg-neutral-50/50 px-4 md:px-6 py-4 border-b border-neutral-100 flex justify-between items-center gap-2">
            <div class="flex items-center gap-3">
              <div class="hidden sm:flex w-10 h-10 items-center justify-center bg-white rounded-xl border border-neutral-200 text-neutral-400 font-black">#</div>
              <div>
                <p class="text-[10px] text-neutral-400 uppercase font-black tracking-widest leading-none mb-1.5">Transaction ID</p>
                <p class="font-mono text-xs md:text-sm font-bold text-neutral-900">${order.id}</p>
              </div>
            </div>
            <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase border tracking-wider ${getStatusStyle(order.status)}">
              ${order.status}
            </span>
          </div>
          
          <!-- Daftar Item -->
          <div class="p-4 md:p-6 space-y-5">
            ${order.items.map(item => `
              <div class="flex justify-between items-center group">
                <div class="flex items-center gap-4">
                  <img src="${item.img}" class="w-12 h-12 md:w-16 md:h-16 object-cover rounded-2xl border border-neutral-100 group-hover:scale-105 transition-transform" />
                  <div>
                    <p class="font-black text-neutral-900 text-sm md:text-base group-hover:text-yellow-600 transition-colors">${item.name}</p>
                    <p class="text-[11px] text-neutral-400 font-bold uppercase mt-0.5">${item.size}m² • Professional Service</p>
                  </div>
                </div>
                <p class="font-black text-neutral-900 text-sm md:text-base">${priceFormatter.format(item.price)}</p>
              </div>
            `).join('')}
          </div>
          
          <!-- Footer Card -->
          <div class="mx-4 md:mx-6 pb-6 pt-6 border-t border-neutral-100 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-2.5 text-neutral-400 bg-neutral-50 px-3 py-1.5 rounded-lg border border-neutral-100">
               <div class="i-ph-calendar-blank-bold text-lg"></div>
               <p class="text-[11px] font-bold uppercase tracking-tight">${dateFormatter.format(new Date(order.date))}</p>
            </div>
            
            <div class="flex items-center justify-between md:justify-end w-full md:w-auto gap-6">
                <div class="text-right">
                  <p class="text-[10px] text-neutral-400 uppercase font-black tracking-widest leading-none mb-1.5 text-right">Total Pembayaran</p>
                  <p class="text-xl md:text-2xl font-black text-neutral-900 leading-none">${priceFormatter.format(order.total)}</p>
                </div>
                <button class="w-10 h-10 flex items-center justify-center bg-neutral-900 text-white rounded-xl hover:bg-yellow-400 hover:text-neutral-900 transition-all shadow-lg active:scale-90">
                    <div class="i-ph-caret-right-bold text-lg"></div>
                </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    renderHistory();
  }

  // Best Practice: Re-init on Page Load (View Transitions Support)
  document.addEventListener('astro:page-load', initHistory);
</script>